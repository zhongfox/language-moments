# 3.7 数字

|        | Ruby   | Javascript | Lua | Java | Go |
|--------|--------|------------|-----|------|----|
| 可变性 | 不可变 |            |     |      |    |



---

## Ruby Float

先看看诡异的浮点数运算:

```ruby
% irb
>> 0.2*0.2
0.04000000000000001
```

#### 计算机对小数的表示:

* 固定小数 缺点:不易使用
* 科学计数法
  * 单精度: 32位
  * 双精度: 64位
    1位符号位, 11位指数部, 52位尾数部

#### 限制:

1. 计算机中数的表示是有长度限制的
2. 计算机中的数是用二进制表示的

#### 总结:

* 小数不能完全表示

  0.2在二进制中是循环小数

* 浮点数是有限的
* 浮点数是有误差的
* 对于浮点数, 结合法不成立 `(a + b) * c` 误差比 `a * c + b * c` 大
* 浮点数外部(以十进制)表示比较'整', 内部不一定比较'整'

  ```ruby
  x = 0.0;
  10.times {x += 0.1};
  x == 1.0 #false
  ```

* 有不能比较的时候
  两个浮点数比较要求内部表示完全相同才会判定相等
* 误差会积累

#### 最佳实践:

1. 浮点数不能用==比较
2. 减少运算次数
3. 对于有精度要求的场景, 使用BigDecimal

   ```ruby
   require 'bigdecimal'
   (BigDecimal.new('19.19') * BigDecimal.new('1.234')).to_f
   ```

  BigDecimal做了以下实现:
  * 有效的数字自动扩展
  * 采用十进制技术

  不过天下没有免费的午餐, BigDecimal比Float要慢

